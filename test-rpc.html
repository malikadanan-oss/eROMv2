<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>eROM@AG • RPC Smoke Test</title>

  <!-- Font: Oswald (prasyarat projek) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;500;700&display=swap" rel="stylesheet">

  <!-- SweetAlert2 untuk notifikasi -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    html,body{margin:0;padding:0;background:#f6f8fb;color:#111827;font-family:'Oswald',Arial,sans-serif}
    .wrap{max-width:900px;margin:24px auto;padding:12px}
    .card{background:#fff;border:1px solid #e5e7eb;border-radius:14px;padding:16px;box-shadow:0 2px 10px rgba(0,0,0,.05)}
    .muted{color:#6b7280}
    button{font-family:inherit;font-size:1rem;border:none;background:#2563eb;color:#fff;padding:10px 16px;border-radius:10px;cursor:pointer}
    button.ghost{background:#fff;color:#111827;border:1px solid #e5e7eb}
    #app-output{min-height:120px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>eROM@AG • RPC Smoke Test</h1>
    <div class="card">
      <p class="muted">Ujian sambungan RPC: <code>fn_admin_check</code> dan <code>fn_create_booking</code>.</p>
      <div class="row">
        <button id="btnCheckAdmin">Uji Admin Check</button>
        <button id="btnCreateSample" class="ghost">Cipta Tempahan Contoh</button>
      </div>
    </div>

    <div id="app-output" class="wrap"></div>
  </div>

  <!-- KONFIGURASI RUNTIME: pastikan ini MENDULUI skrip module -->
  <script>
    window.SUPABASE_URL = "https://ixnnhsorpyqqxytqaclu.supabase.co";
    window.SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml4bm5oc29ycHlxcXh5dHFhY2x1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA2NjEyODYsImV4cCI6MjA3NjIzNzI4Nn0.tNHoxI9-RYk6JEocV5o26o35X-5OaOg1Jb2XTwhtlMQ";
  </script>

  <!-- Modul: gunakan supabase-js v2 -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // Client minimal untuk ujian ini
    const supa = createClient(window.SUPABASE_URL, window.SUPABASE_ANON_KEY, {
      auth: { persistSession: false, autoRefreshToken: false }
    });

    const Toast = Swal.mixin({ toast:true, position:'top', timer:2200, showConfirmButton:false, timerProgressBar:true });
    const $ = (id) => document.getElementById(id);

    // Uji RPC: fn_admin_check('ppdag')
    $('btnCheckAdmin').addEventListener('click', async () => {
      try{
        const { data, error } = await supa.rpc('fn_admin_check', { pw: 'ppdag' });
        if (error) throw error;
        data === true
          ? Toast.fire({ icon:'success', title:'Admin OK' })
          : Swal.fire('Gagal', 'Admin password salah (default: ppdag)', 'error');
      }catch(err){
        Swal.fire('Ralat', (err && err.message) ? err.message : String(err), 'error');
      }
    });

    // Utiliti: pilih hari bekerja seterusnya (Isnin–Jumaat) dalam zon tempatan
    function nextWorkingDayISO() {
      const d = new Date();
      d.setDate(d.getDate() + 1);              // mula dari esok
      while ([0,6].includes(d.getDay())) {     // 0=Ahad, 6=Sabtu
        d.setDate(d.getDate() + 1);
      }
      d.setHours(0,0,0,0);
      // tukar ke ISO YYYY-MM-DD tanpa isu zon
      return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    }

    // Cipta satu tempahan contoh 09:00–10:00 pada hari bekerja seterusnya
    $('btnCreateSample').addEventListener('click', async () => {
      try{
        const ymd = nextWorkingDayISO();
        const args = {
          p_room: 'Bilik Mesyuarat 1',
          p_date: ymd,
          p_start: '09:00',
          p_end: '10:00',
          p_category: 'Ujian',
          p_note: 'Smoke test',
          p_sektor: 'Sektor Perancangan',
          p_nama: 'En. Saifullah Bin Abdul Wahab'
        };
        const { data, error } = await supa.rpc('fn_create_booking', args);
        if (error) throw error;
        if (data?.ok) {
          Toast.fire({ icon:'success', title:`Tempahan contoh berjaya (${ymd})` });
        } else {
          Swal.fire('Gagal', data?.error || 'Tidak diketahui', 'error');
        }
      }catch(err){
        Swal.fire('Ralat', (err && err.message) ? err.message : String(err), 'error');
      }
    });
  </script>
</body>
</html>
